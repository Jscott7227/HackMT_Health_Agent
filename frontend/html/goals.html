<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Benji – Your Goals</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        body {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .goals-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .goals-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .goals-headline {
            font-family: 'Crimson Pro', serif;
            font-size: 2.75rem;
            font-weight: 600;
            color: var(--text-primary, #1a1a1a);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .goals-subtext {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.125rem;
            color: var(--text-secondary, #666);
            max-width: 650px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .goals-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .goal-card {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(140, 162, 145, 0.2);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(10, 24, 16, 0.08);
        }

        .goal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--sage-light, #a8c4ae), var(--sage, #8ca291));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .goal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(10, 24, 16, 0.12);
        }

        .goal-card:hover::before {
            opacity: 1;
        }

        .goal-card.accepted {
            border-color: var(--sage, #8ca291);
            background: rgba(140, 162, 145, 0.08);
        }

        .goal-card.accepted::before {
            opacity: 1;
        }

        .goal-header {
            display: flex;
            align-items: flex-start;
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .goal-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(140, 162, 145, 0.1), rgba(140, 162, 145, 0.15));
            border-radius: 12px;
            flex-shrink: 0;
        }

        .goal-icon i {
            font-size: 1.5rem;
            color: var(--sage, #8ca291);
        }

        .goal-content {
            flex: 1;
        }

        .goal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary, #1a1a1a);
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .goal-smart-details {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .smart-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .smart-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.813rem;
            font-weight: 600;
            color: var(--sage, #8ca291);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 100px;
            padding-top: 2px;
        }

        .smart-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.938rem;
            color: var(--text-secondary, #555);
            line-height: 1.6;
            flex: 1;
        }

        .goal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .goal-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.938rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .goal-btn i {
            font-size: 1rem;
        }

        .goal-btn-accept {
            background: linear-gradient(135deg, var(--sage-light, #a8c4ae), var(--sage, #8ca291));
            color: white;
        }

        .goal-btn-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(140, 162, 145, 0.35);
        }

        .goal-btn-edit {
            background: white;
            border: 2px solid rgba(140, 162, 145, 0.3);
            color: var(--text-secondary, #666);
        }

        .goal-btn-edit:hover {
            border-color: var(--sage, #8ca291);
            color: var(--sage, #8ca291);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(140, 162, 145, 0.2);
        }

        .goal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .goal-status {
            display: inline-flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.938rem;
            font-weight: 600;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .goal-status.accepted {
            background: rgba(140, 162, 145, 0.15);
            color: var(--sage, #8ca291);
        }

        .goal-status.accepted:hover {
            background: rgba(140, 162, 145, 0.22);
        }

        .goals-count {
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary, #666);
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .finalize-section {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2.5rem;
            border-top: 2px solid rgba(140, 162, 145, 0.2);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .finalize-btn,
        .secondary-btn {
            padding: 1rem 1.5rem;
            border-radius: 14px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.625rem;
            min-width: 220px;
            flex: 1 1 220px;
            max-width: 280px;
        }

        .finalize-btn {
            background: linear-gradient(135deg, var(--sage-light, #a8c4ae), var(--sage, #8ca291));
            color: white;
        }

        .finalize-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(140, 162, 145, 0.4);
        }

        .finalize-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .secondary-btn {
            background: white;
            color: var(--sage, #8ca291);
            border: 2px solid var(--sage, #8ca291);
        }

        .secondary-btn:hover {
            background: rgba(140, 162, 145, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(140, 162, 145, 0.25);
        }

        .finalize-validation-msg {
            display: none;
            margin-top: 1rem;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            background: rgba(200, 80, 80, 0.1);
            color: #b33;
            font-size: 0.938rem;
            font-family: 'DM Sans', sans-serif;
        }

        .finalize-validation-msg.visible {
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(140, 162, 145, 0.2);
            border-top-color: var(--sage, #8ca291);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary, #666);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 24px 72px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            margin-bottom: 2rem;
        }

        .modal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary, #1a1a1a);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary, #666);
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .form-label {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.938rem;
            font-weight: 600;
            color: var(--text-primary, #1a1a1a);
        }

        .form-input,
        .form-textarea {
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            padding: 1rem 1.25rem;
            border: 2px solid rgba(140, 162, 145, 0.25);
            border-radius: 14px;
            transition: all 0.25s ease;
            background: rgba(255, 255, 255, 0.95);
            color: var(--text-primary, #1a1a1a);
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--sage, #8ca291);
            box-shadow: 0 0 0 4px rgba(140, 162, 145, 0.1);
            background: white;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(56px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(140, 162, 145, 0.05);
            border-radius: 12px;
        }

        .icon-option {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .icon-option i {
            font-size: 1.5rem;
            color: var(--sage, #8ca291);
        }

        .icon-option:hover {
            border-color: var(--sage, #8ca291);
            transform: scale(1.05);
        }

        .icon-option.selected {
            background: var(--sage, #8ca291);
            border-color: var(--sage, #8ca291);
        }

        .icon-option.selected i {
            color: white;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: 14px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--sage-light, #a8c4ae), var(--sage, #8ca291));
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(140, 162, 145, 0.35);
        }

        .modal-btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary, #666);
        }

        .modal-btn-secondary:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Page transitions */
        body {
            transition: opacity 0.4s ease;
        }
        body.page-loading {
            opacity: 0;
        }
        body.page-visible {
            opacity: 1;
        }
        body.page-transition-out {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body data-page="goals" class="page-loading">

    <!-- Background -->
    <div class="background-layers">
        <div class="grain"></div>
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">Generating personalized goals...</p>
        </div>
    </div>

    <!-- Goals Content -->
    <div class="goals-container">
        <div class="goals-header">
            <h1 class="goals-headline">Your Personalized Goals</h1>
            <p class="goals-subtext">Review your SMART goals below. Accept the ones that resonate with you or edit them to better fit your journey.</p>
        </div>

        <p class="goals-count"><span id="acceptedCount">0</span> / <span id="totalCount">0</span> goals accepted</p>

        <div class="goals-list" id="goalsList"></div>

        <div class="finalize-section">
            <p class="finalize-validation-msg" id="finalizeValidationMsg">Please accept at least one goal before continuing.</p>
            <div class="button-group">
                <button class="finalize-btn" id="finalizeBtn" disabled onclick="finalizeGoals()">
                    <i class="fas fa-check-circle"></i>
                    Continue with Selected Goals
                </button>
                <button class="secondary-btn" id="regenerateBtn" type="button">
                    <i class="fas fa-sync-alt"></i>
                    Regenerate Suggestions
                </button>
                <button class="secondary-btn" type="button" onclick="openManualInputModal()">
                    <i class="fas fa-plus-circle"></i>
                    Add Custom Goal
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Input Modal -->
    <div class="modal-overlay" id="manualInputModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create SMART Goal</h2>
                <p class="modal-subtitle">Design a goal that's Specific, Measurable, Attainable, Relevant, and Time-bound</p>
            </div>

            <form class="modal-form" id="manualGoalForm">
                <div class="form-group">
                    <label class="form-label">Select an Icon</label>
                    <div class="icon-picker" id="iconPicker">
                        <div class="icon-option selected" data-icon="fa-bullseye" onclick="selectIcon(this)">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-dumbbell" onclick="selectIcon(this)">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-running" onclick="selectIcon(this)">
                            <i class="fas fa-running"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-heartbeat" onclick="selectIcon(this)">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-bed" onclick="selectIcon(this)">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-spa" onclick="selectIcon(this)">
                            <i class="fas fa-spa"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-chart-line" onclick="selectIcon(this)">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-walking" onclick="selectIcon(this)">
                            <i class="fas fa-walking"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-tint" onclick="selectIcon(this)">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-apple-alt" onclick="selectIcon(this)">
                            <i class="fas fa-apple-alt"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-trophy" onclick="selectIcon(this)">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="icon-option" data-icon="fa-fire" onclick="selectIcon(this)">
                            <i class="fas fa-fire"></i>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="goalSpecific">Specific *</label>
                    <textarea
                        id="goalSpecific"
                        name="goalSpecific"
                        class="form-textarea"
                        placeholder="What exactly do you want to accomplish?"
                        required
                        maxlength="200"
                        rows="2"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="goalMeasurable">Measurable *</label>
                    <textarea
                        id="goalMeasurable"
                        name="goalMeasurable"
                        class="form-textarea"
                        placeholder="How will you track your progress?"
                        required
                        maxlength="200"
                        rows="2"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="goalAttainable">Attainable *</label>
                    <textarea
                        id="goalAttainable"
                        name="goalAttainable"
                        class="form-textarea"
                        placeholder="How will you achieve this goal?"
                        required
                        maxlength="200"
                        rows="2"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="goalRelevant">Relevant *</label>
                    <textarea
                        id="goalRelevant"
                        name="goalRelevant"
                        class="form-textarea"
                        placeholder="Why is this goal important to you?"
                        required
                        maxlength="200"
                        rows="2"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="goalTimeBound">Timeframe *</label>
                    <input
                        type="text"
                        id="goalTimeBound"
                        name="goalTimeBound"
                        class="form-input"
                        placeholder="When will you achieve this goal?"
                        required
                        maxlength="100"
                    />
                </div>

                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeManualInputModal()">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn modal-btn-primary">
                        <i class="fas fa-save"></i>
                        Save Goal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        const MAX_INITIAL_GOALS = 3;
        let selectedIcon = 'fa-bullseye';
        let editingGoalId = null;
        let displayedGoals = [];

        // Initialize goals on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeGoals();
            setupEventListeners();
        });

        function setupEventListeners() {
            const form = document.getElementById('manualGoalForm');
            if (form) form.addEventListener('submit', handleManualFormSubmit);

            const modal = document.getElementById('manualInputModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeManualInputModal();
                });
            }

            const regenerateBtn = document.getElementById('regenerateBtn');
            if (regenerateBtn) regenerateBtn.addEventListener('click', regenerateGoals);
        }

        // Initialize goals from LLM
        async function initializeGoals() {
            showLoading(true);

            try {
                const session = BenjiAPI.getSession();
                if (!session || !session.user_id) {
                    throw new Error('No session found');
                }

                // Get user profile info for context
                const profileInfo = await BenjiAPI.getProfileInfo(session.user_id);

                // Generate goals from LLM
                const response = await BenjiAPI.postGoalsGenerate({
                    user_id: session.user_id,
                    profile_info: profileInfo,
                    count: MAX_INITIAL_GOALS
                });

                if (response.smart_goals && Array.isArray(response.smart_goals)) {
                    displayedGoals = response.smart_goals.map(goal => ({
                        ...goal,
                        icon: goal.icon || 'fa-bullseye',
                        id: Date.now() + Math.random(),
                        status: 'pending',
                        start_date: goal.start_date || new Date().toISOString()
                    }));
                } else {
                    throw new Error('Invalid goals response');
                }

            } catch (error) {
                console.error('Failed to generate goals:', error);
                // Fallback to empty state
                displayedGoals = [];
            } finally {
                showLoading(false);
                renderGoals();
            }
        }

        // Regenerate goals (keep accepted ones)
        async function regenerateGoals() {
            showLoading(true);

            try {
                const session = BenjiAPI.getSession();
                if (!session || !session.user_id) {
                    throw new Error('No session found');
                }

                const acceptedGoals = displayedGoals.filter(g => g.status === 'accepted');
                const neededCount = Math.max(MAX_INITIAL_GOALS - acceptedGoals.length, 1);

                const profileInfo = await BenjiAPI.getProfileInfo(session.user_id);

                const response = await BenjiAPI.postGoalsGenerate({
                    user_id: session.user_id,
                    profile_info: profileInfo,
                    count: neededCount,
                    exclude_goals: acceptedGoals
                });

                if (response.smart_goals && Array.isArray(response.smart_goals)) {
                    const newGoals = response.smart_goals.map(goal => ({
                        ...goal,
                        icon: goal.icon || 'fa-bullseye',
                        id: Date.now() + Math.random(),
                        status: 'pending',
                        start_date: goal.start_date || new Date().toISOString()
                    }));

                    displayedGoals = [...acceptedGoals, ...newGoals];
                }

            } catch (error) {
                console.error('Failed to regenerate goals:', error);
                alert('Unable to generate new goals. Please try again.');
            } finally {
                showLoading(false);
                renderGoals();
            }
        }

        // Render all goals to the DOM
        function renderGoals() {
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = '';

            if (displayedGoals.length === 0) {
                goalsList.innerHTML = '<p style="text-align: center; color: #999;">No goals yet. Add a custom goal to get started.</p>';
            } else {
                displayedGoals.forEach((goal) => {
                    const goalCard = createGoalCard(goal);
                    goalsList.appendChild(goalCard);
                });
            }

            updateGoalCount();
        }

        // Create a single goal card element
        function createGoalCard(goal) {
            const card = document.createElement('div');
            card.className = `goal-card ${goal.status === 'accepted' ? 'accepted' : ''}`;
            card.id = `goal-${goal.id}`;

            // Use Specific field as title, truncate if too long
            const goalTitle = goal.Specific
                ? (goal.Specific.length > 80 ? goal.Specific.substring(0, 77) + '...' : goal.Specific)
                : (goal.title || 'Untitled Goal');

            // Format start date if available
            const startDate = goal.start_date
                ? new Date(goal.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : null;

            const smartDetails = `
                ${goal.Measurable ? `<div class="smart-item"><div class="smart-label">Measurable</div><div class="smart-text">${goal.Measurable}</div></div>` : ''}
                ${goal.Attainable ? `<div class="smart-item"><div class="smart-label">Attainable</div><div class="smart-text">${goal.Attainable}</div></div>` : ''}
                ${goal.Relevant ? `<div class="smart-item"><div class="smart-label">Relevant</div><div class="smart-text">${goal.Relevant}</div></div>` : ''}
                ${goal.Time_Bound ? `<div class="smart-item"><div class="smart-label">Timeframe</div><div class="smart-text">${goal.Time_Bound}</div></div>` : ''}
            `;

            const actions = goal.status === 'accepted'
                ? `<div class="goal-status accepted" onclick="unacceptGoal('${goal.id}')">
                        <i class="fas fa-check-circle"></i>
                        Accepted · tap to undo
                   </div>`
                : `<div class="goal-actions">
                        <button class="goal-btn goal-btn-accept" onclick="acceptGoal('${goal.id}')">
                            <i class="fas fa-check-circle"></i>
                            Accept
                        </button>
                        <button class="goal-btn goal-btn-edit" onclick="editGoal('${goal.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                   </div>`;

            card.innerHTML = `
                <div class="goal-header">
                    <div class="goal-icon">
                        <i class="fas ${goal.icon}"></i>
                    </div>
                    <div class="goal-content">
                        <h3 class="goal-title">${goalTitle}</h3>
                    </div>
                </div>
                <div class="goal-smart-details">
                    ${smartDetails}
                </div>
                ${actions}
            `;

            return card;
        }

        // Accept a goal
        function acceptGoal(goalId) {
            const goal = displayedGoals.find(g => g.id.toString() === goalId.toString());
            if (goal) {
                goal.status = 'accepted';
                renderGoals();
            }
        }

        // Unaccept a goal
        function unacceptGoal(goalId) {
            const goal = displayedGoals.find(g => g.id.toString() === goalId.toString());
            if (goal) {
                goal.status = 'pending';
                renderGoals();
            }
        }

        // Edit a goal
        function editGoal(goalId) {
            const goal = displayedGoals.find(g => g.id.toString() === goalId.toString());
            if (!goal) return;
            editingGoalId = goal.id;
            openManualInputModal(goal);
        }

        // Update the goal counter
        function updateGoalCount() {
            const acceptedGoals = displayedGoals.filter(g => g.status === 'accepted');
            document.getElementById('acceptedCount').textContent = acceptedGoals.length;
            document.getElementById('totalCount').textContent = displayedGoals.length;

            const finalizeBtn = document.getElementById('finalizeBtn');
            finalizeBtn.disabled = acceptedGoals.length === 0;
        }

        // Modal functions
        function openManualInputModal(goal = null) {
            const modal = document.getElementById('manualInputModal');
            if (!modal) return;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            const form = document.getElementById('manualGoalForm');
            if (!form) return;

            if (goal) {
                editingGoalId = goal.id;
                form.goalSpecific.value = goal.Specific || '';
                form.goalMeasurable.value = goal.Measurable || '';
                form.goalAttainable.value = goal.Attainable || '';
                form.goalRelevant.value = goal.Relevant || '';
                form.goalTimeBound.value = goal.Time_Bound || '';

                const iconEl = document.querySelector(`.icon-option[data-icon="${goal.icon}"]`) || document.querySelector('.icon-option[data-icon="fa-bullseye"]');
                selectIcon(iconEl);
            } else {
                editingGoalId = null;
                form.reset();
                selectIcon(document.querySelector('.icon-option[data-icon="fa-bullseye"]'));
            }
        }

        function closeManualInputModal() {
            const modal = document.getElementById('manualInputModal');
            if (!modal) return;
            modal.classList.remove('active');
            document.body.style.overflow = '';
            editingGoalId = null;
            const form = document.getElementById('manualGoalForm');
            if (form) form.reset();
            selectIcon(document.querySelector('.icon-option[data-icon="fa-bullseye"]'));
        }

        function handleManualFormSubmit(event) {
            event.preventDefault();
            const form = event.target;

            const goalPayload = {
                icon: selectedIcon,
                Specific: form.goalSpecific.value.trim(),
                Measurable: form.goalMeasurable.value.trim(),
                Attainable: form.goalAttainable.value.trim(),
                Relevant: form.goalRelevant.value.trim(),
                Time_Bound: form.goalTimeBound.value.trim(),
                status: 'pending'
            };

            if (editingGoalId) {
                const goal = displayedGoals.find(g => g.id === editingGoalId);
                if (goal) {
                    // Keep existing start_date when editing
                    Object.assign(goal, goalPayload);
                }
            } else {
                // Set start_date automatically for new goals
                displayedGoals.push({
                    ...goalPayload,
                    id: Date.now() + Math.random(),
                    start_date: new Date().toISOString()
                });
            }

            renderGoals();
            closeManualInputModal();
        }

        // Select icon
        function selectIcon(element) {
            if (!element) return;
            document.querySelectorAll('.icon-option').forEach(option => option.classList.remove('selected'));
            element.classList.add('selected');
            selectedIcon = element.dataset.icon;
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                if (show) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        // Finalize and save accepted goals
        function finalizeGoals() {
            const validationMsg = document.getElementById('finalizeValidationMsg');
            validationMsg.classList.remove('visible');
            const acceptedGoals = displayedGoals.filter(g => g.status === 'accepted');

            if (acceptedGoals.length === 0) {
                validationMsg.classList.add('visible');
                return;
            }

            // Save to localStorage and backend
            localStorage.setItem('benjiAcceptedGoals', JSON.stringify(acceptedGoals));

            if (window.BenjiAPI) {
                const session = BenjiAPI.getSession();
                if (session && session.user_id) {
                    BenjiAPI.postGoalsAccepted(session.user_id, acceptedGoals).catch(function (err) {
                        console.warn('Backend save goals failed:', err);
                    });
                }
            }

            // Smooth fade-out then navigate
            document.body.classList.add('page-transition-out');
            setTimeout(function() {
                window.location.href = 'index.html';
            }, 450);
        }

        // Fade-in on load
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.remove('page-loading');
            document.body.classList.add('page-visible');
        });
    </script>
</body>
</html>
